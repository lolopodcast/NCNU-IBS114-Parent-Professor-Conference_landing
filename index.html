<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSA - Road Safety Advisor</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Leaflet CSS & JS (For Real Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Custom Styles -->
    <style>
        .perspective-1000 { perspective: 1000px; }
        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        /* Fix Leaflet Z-Index in Tailwind */
        .leaflet-pane { z-index: 10 !important; }
        .leaflet-bottom.leaflet-right { z-index: 20 !important; }
        /* Custom Marker Icons for Leaflet */
        .custom-pin { background: transparent; border: none; }
        .custom-pin svg { filter: drop-shadow(0 4px 3px rgb(0 0 0 / 0.3)); }
        
        /* Pulse animation for hotspots */
        @keyframes pulse-red {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .hotspot-pulse {
            animation: pulse-red 2s infinite;
        }
    </style>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    animation: { 'dash': 'dash 20s linear infinite' },
                    keyframes: {
                        dash: { '0%': { strokeDashoffset: '1000' }, '100%': { strokeDashoffset: '0' } }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-50 text-slate-800 transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- 1. Icons (SVG Components) ---
        const IconBase = ({ children, className = "", color = "currentColor", size = 24, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {children}
            </svg>
        );

        const User = (props) => <IconBase {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
        const Mail = (props) => <IconBase {...props}><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></IconBase>;
        const Globe = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10 15.3 15.3 0 0 1-4 10z"/></IconBase>;
        const Languages = (props) => <IconBase {...props}><path d="m5 8 6 13"/><path d="m11 8-6 13"/><path d="M4 14h8"/><path d="M13 2h9"/><path d="M13 7h9"/><path d="M18 2v10"/></IconBase>;
        const Moon = (props) => <IconBase {...props}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></IconBase>;
        const Sun = (props) => <IconBase {...props}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></IconBase>;
        const LogOut = (props) => <IconBase {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></IconBase>;
        const Shield = (props) => <IconBase {...props}><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/></IconBase>;
        const Thermometer = (props) => <IconBase {...props}><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/></IconBase>;
        const Gauge = (props) => <IconBase {...props}><path d="m12 14 4-4"/><path d="M3.34 19a10 10 0 1 1 17.32 0"/></IconBase>;
        const MapPin = (props) => <IconBase {...props}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconBase>;
        const Plus = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const ZoomIn = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="11" x2="11" y1="8" y2="14"/><line x1="8" x2="14" y1="11" y2="11"/></IconBase>;
        const ZoomOut = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="8" x2="14" y1="11" y2="11"/></IconBase>;
        const Eye = (props) => <IconBase {...props}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const EyeOff = (props) => <IconBase {...props}><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7c.44 0 .87-.03 1.28-.09"/><line x1="2" x2="22" y1="2" y2="22"/></IconBase>;
        const AlertTriangle = (props) => <IconBase {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></IconBase>;
        const BookOpen = (props) => <IconBase {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>;
        const GraduationCap = (props) => <IconBase {...props}><path d="M21.42 10.922a1 1 0 0 0-.019-1.838L12.83 5.18a2 2 0 0 0-1.66 0L2.6 9.08a1 1 0 0 0 0 1.832l8.57 3.908a2 2 0 0 0 1.66 0z"/><path d="M22 10v6"/><path d="M6 12.5V16a6 2 0 0 0 12 0v-3.5"/></IconBase>;
        const BarChart3 = (props) => <IconBase {...props}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></IconBase>;
        const Building = (props) => <IconBase {...props}><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M8 10h.01"/><path d="M16 10h.01"/><path d="M8 14h.01"/><path d="M16 14h.01"/></IconBase>;
        const ExternalLink = (props) => <IconBase {...props}><path d="M15 3h6v6"/><path d="M10 14 21 3"/><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/></IconBase>;
        const RotateCcw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconBase>;
        const PlayCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></IconBase>;
        const CheckCircle = (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>;
        const XCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></IconBase>;
        const Lightbulb = (props) => <IconBase {...props}><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></IconBase>;
        const Activity = (props) => <IconBase {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconBase>;
        const ArrowRight = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconBase>;
        const Download = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>;
        const MousePointer2 = (props) => <IconBase {...props}><path d="m4 4 7.07 17 2.51-7.39L21 11.07z"/></IconBase>;
        const Cloud = (props) => <IconBase {...props}><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><path d="M17.5 19c3.037 0 5.5-2.239 5.5-5s-2.463-5-5.5-5c-1.023 0-1.974.254-2.793.693"/><path d="M11.607 9.693C11.385 6.48 8.685 4 5.5 4S-.385 6.48-.607 9.693"/></IconBase>;
        const Footprints = (props) => <IconBase {...props}><path d="M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 1.49-6 4.5-6C9.37 2 11 3.8 11 8c0 1.25-1.25 2-1.25 4.5.03 2.72 1.49 6 4.5 6 1.87 0 3.5-1.8 3.5-6 0-1.25-1.25-2-1.25-4.5"/><path d="M13.29 17.5c.37-.58.96-1 1.71-1 1.2 0 2 .8 2 2 0 1.2-.8 2-2 2-1.2 0-2-.8-2-2 0-.3.1-.6.29-.9z"/><path d="M4.29 17.5c.37-.58.96-1 1.71-1 1.2 0 2 .8 2 2 0 1.2-.8 2-2 2-1.2 0-2-.8-2-2 0-.3.1-.6.29-.9z"/></IconBase>;
        const Bike = (props) => <IconBase {...props}><circle cx="5.5" cy="17.5" r="3.5"/><circle cx="18.5" cy="17.5" r="3.5"/><path d="M15 6a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm-3 11.5V14l-3-3 4-3 2 3h2"/></IconBase>;
        const Car = (props) => <IconBase {...props}><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><path d="M9 17h6"/><circle cx="17" cy="17" r="2"/></IconBase>;
        const Bus = (props) => <IconBase {...props}><path d="M8 6v6"/><path d="M15 6v6"/><path d="M2 12h19.6"/><path d="M18 18h3s.5-1.7.8-2.8c.1-.4.2-.8.2-1.2 0-.4-.1-.8-.2-1.2l-1.4-5C20.1 6.8 19.1 6 18 6H4a2 2 0 0 0-2 2v10h3"/><circle cx="7" cy="18" r="2"/><path d="M9 18h5"/><circle cx="16" cy="18" r="2"/></IconBase>;
        const Triangle = (props) => <IconBase {...props}><path d="M13.73 4a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/></IconBase>;
        const Square = (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="3" rx="2"/></IconBase>;
        const SunIcon = Sun; 
        const MoonIcon = Moon;

        const ScooterIcon = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}>
                <circle cx="16" cy="17" r="4" />
                <path d="M5 17h-2v-6l2-1h3l4 3.5" />
                <path d="M7 17l1.5-6h4.5" />
                <path d="M12 5h2.5l2 3" />
            </svg>
        );

        // --- 2. Constants & Data ---
        const LINKS = {
            prof: "https://www.ibs.ncnu.edu.tw/index.php/faculty/tenured-professor/299-smlo",
            ibs: "https://www.ibs.ncnu.edu.tw/",
            ncnu: "https://rpage.ncnu.edu.tw/"
        };
        const SCHOOLS = ["國立暨南國際大學 (National Chi Nan University)", "國立台灣大學 (National Taiwan University)", "國立清華大學 (National Tsing Hua University)", "國立交通大學 (National Chiao Tung University)", "國立政治大學 (National Chengchi University)"];
        
        const SCHOOL_COORDS = {
            "國立暨南國際大學 (National Chi Nan University)": { lat: 23.952, lon: 120.927 },
            "國立台灣大學 (National Taiwan University)": { lat: 25.0174, lon: 121.5379 },
            "國立清華大學 (National Tsing Hua University)": { lat: 24.7961, lon: 120.9967 },
            "國立交通大學 (National Chiao Tung University)": { lat: 24.7868, lon: 120.9972 },
            "國立政治大學 (National Chengchi University)": { lat: 24.9869, lon: 121.5753 }
        };

        const LOCATIONS = {
            start: ["校門口 (Main Gate)", "學生宿舍 (Dormitory)", "行政大樓 (Admin Bldg)"],
            end: ["轉運站 (Bus Station)", "市區中心 (City Center)", "火車站 (Train Station)"]
        };
        const DEFAULT_SCHOOL = "國立暨南國際大學 (National Chi Nan University)";

        const UI_TEXT = {
            zh: {
                brandSubtitle: "道路風險與道安教練", slogan: "Know Well, Stay Safe", valueProp: "道路風險與道安教練",
                loginTime: "登入時間", username: "使用者名稱 (必填)", email: "使用者 Email (選填)", selectSchool: "選擇學校",
                enterName: "輸入您的姓名", enterEmail: "name@example.com", btnRisk: "開始風險評估", btnGuide: "探索安全指引",
                btnCap: "檢測安全能力", btnRecord: "查看學習紀錄", btnOfficial: "全國道安資訊", logout: "登出",
                creator: "Prof. Shihmin Lo, PhD", weather: "天氣概況", traffic: "交通忙碌", transport: "交通工具",
                departureTime: "出發時間", mapOptions: "路徑設定", scale: "比例尺", addStop: "新增中途點", start: "出發地",
                end: "目的地", mapGate: "校門口", mapStation: "轉運站", mapStop: "停靠", tabRisk: "風險評估", tabGuide: "安全指引",
                tabCap: "安全能力", tabRecord: "學習紀錄", tabOfficial: "道安資訊網", summary: "重點摘要",
                knowledge: "必備知識 (點擊翻轉)", skills: "必備技能 (點擊翻轉)", attitude: "必備態度 (點擊翻轉)",
                quiz: "牛刀小試 (隨機3題)", quizScore: "本單元得分", checkAns: "檢查答案", tryAgain: "再試一次",
                glossary: "字彙解釋 (完整收錄)", selectTerm: "請選擇詞彙查看解釋...", glossaryDef: "定義與說明",
                footerRights: "版權所有", lastUpdate: "最後更新", userProfile: "使用者資料", learningProgress: "學習進度總覽",
                correctRate: "答對率", questions: "題", score: "分", statusHigh: "優秀", statusMid: "良好", statusLow: "待加強",
                mapSimNote: "操作說明：滾輪縮放地圖，按住左鍵拖曳移動", flipHint: "點擊翻轉", mapModeSim: "情境模擬地圖",
                mapModeReal: "真實地圖 (OSM)", officialTitle: "全國道路安全資訊與資源", officialChartTitle: "近年全國道路交通事故死亡人數趨勢 (模擬數據)",
                officialLinks: "重要官方資源連結", togglePanel: "儀表板設定", toggleMap: "地圖顯示", toggleContent: "詳細內容",
                exportCSV: "匯出學習紀錄 (CSV)", trafficLabel: "模擬路況", showHotspots: "⚠️ 顯示車禍熱點 (模擬)"
            },
            en: {
                brandSubtitle: "Road Risk & Safety Coach", slogan: "Know Well, Stay Safe", valueProp: "Your Road Safety Companion",
                loginTime: "Login Time", username: "User Name (Required)", email: "User Email (Optional)", selectSchool: "Select School",
                enterName: "Enter your name", enterEmail: "name@example.com", btnRisk: "Start Risk Assessment", btnGuide: "Explore Safety Guidelines",
                btnCap: "Check Safety Capability", btnRecord: "View Learning Record", btnOfficial: "National Safety Info", logout: "Log Out",
                creator: "Prof. Shihmin Lo, PhD", weather: "Weather", traffic: "Traffic", transport: "Transport",
                departureTime: "Time", mapOptions: "Route Settings", scale: "Scale", addStop: "Add Stop", start: "Start",
                end: "End", mapGate: "Main Gate", mapStation: "Station", mapStop: "Stop", tabRisk: "Risk Assessment",
                tabGuide: "Safety Guidelines", tabCap: "Safety Capability", tabRecord: "Learning Record", tabOfficial: "Official Info",
                summary: "Summary", knowledge: "Essential Knowledge (Click to Flip)", skills: "Essential Skills (Click to Flip)",
                attitude: "Essential Attitude (Click to Flip)", quiz: "Quick Quiz (Random 3)", quizScore: "Score",
                checkAns: "Check Answers", tryAgain: "Try Again", glossary: "Key Vocabulary", selectTerm: "Select a term to define...",
                glossaryDef: "Definition", footerRights: "All Rights Reserved", lastUpdate: "Last Updated", userProfile: "User Profile",
                learningProgress: "Learning Progress", correctRate: "Accuracy", questions: "Qs", score: "Pts", statusHigh: "Excellent",
                statusMid: "Good", statusLow: "Needs Improvement", mapSimNote: "Usage: Scroll to Zoom, Drag to Pan", flipHint: "Click to flip",
                mapModeSim: "Simulated Map", mapModeReal: "Real Map (OSM)", officialTitle: "National Road Safety Information & Resources",
                officialChartTitle: "Annual Road Traffic Fatalities Trend (Simulated)", officialLinks: "Important Official Resources",
                togglePanel: "Dashboard", toggleMap: "Map View", toggleContent: "Details", exportCSV: "Export CSV", trafficLabel: "Traffic",
                showHotspots: "⚠️ Show Hotspots (Sim)"
            }
        };

        const QUIZ_DISPLAY_COUNT = 3;
        const getRandomIndices = (total, count) => {
            const indices = Array.from({ length: total }, (_, i) => i);
            return indices.sort(() => 0.5 - Math.random()).slice(0, count);
        };

        const CONTENT_DATA = {
            risk: {
                zh: {
                    title: "風險評估", 
                    summary: "透過數據分析協助您識別道路潛在危險。重點包含：1. 識別大型車內輪差與視線死角熱區。2. 理解雨天路面摩擦係數對煞車距離的影響。3. 建立防禦性駕駛預判能力，不只顧好自己，更要預想他人可能的錯誤。",
                    knowledge: [{ title: "視線死角", desc: "大型車轉彎內輪差識別。" }, { title: "摩擦係數", desc: "雨天路面濕滑。" }, { title: "防禦性駕駛", desc: "預想他人可能犯錯。" }],
                    skills: [{ title: "緊急煞車", desc: "ABS作動控制。" }, { title: "視線掃描", desc: "5-8秒掃描後視鏡。" }, { title: "盲點檢查", desc: "變換車道前轉頭。" }],
                    attitude: [{ title: "風險趨避", desc: "選擇安全路徑。" }, { title: "耐心禮讓", desc: "理解路權。" }, { title: "自我監控", desc: "疲勞時休息。" }],
                    glossary: [
                        { term: "內輪差 (Inner Wheel Diff.)", def: "車輛轉彎時，內側前輪畫出的圓半徑大於內側後輪，兩者軌跡的差距稱為內輪差，是大型車捲入事故的主因。" },
                        { term: "防禦性駕駛 (Defensive Driving)", def: "一種駕駛哲學，強調預想周遭可能的危險並預先採取預防措施，而非僅依賴法規或技術。" },
                        { term: "盲點 (Blind Spot)", def: "駕駛人透過後視鏡或直接視線無法看見的車輛周圍區域，變換車道前必須特別檢查。" },
                        { term: "水漂效應 (Aquaplaning)", def: "車輛行駛過積水時，輪胎與路面間形成水膜，導致輪胎失去抓地力而失控的現象。" },
                        { term: "反應時間 (Reaction Time)", def: "從察覺危險到開始採取行動（如踩煞車）所需的時間，受疲勞與分心影響甚鉅。" },
                        { term: "煞車距離 (Braking Distance)", def: "從踩下煞車到車輛完全停止所行駛的距離，隨速度平方增加。" },
                        { term: "安全距離 (Safety Distance)", def: "與前車保持的距離，應足以在突發狀況下安全煞停，通常建議至少2秒。" },
                        { term: "A柱死角 (A-Pillar Blind Spot)", def: "車輛擋風玻璃兩側支柱遮蔽駕駛視線的區域，轉彎時特別危險。" },
                        { term: "路權 (Right of Way)", def: "法律賦予特定用路人在特定路況下優先通行的權利。" },
                        { term: "追撞 (Rear-end Collision)", def: "後車撞擊前車車尾的事故，通常因未保持安全距離造成。" }
                    ],
                    quizPool: [{ q: "大車轉彎危險區?", options: ["後方", "內輪差", "左側"], ans: 1 }, { q: "雨天過標線?", options: ["急煞", "等速直線", "壓車"], ans: 1 }, { q: "防禦性駕駛?", options: ["預設危險", "開快", "只管自己"], ans: 0 }, { q: "大車轉彎?", options: ["加速通過", "遠離", "並行"], ans: 1 }]
                },
                en: {
                    title: "Risk Assessment", 
                    summary: "Data-driven analysis to identify road hazards. Key points: 1. Identify large vehicle blind spots and inner wheel difference. 2. Understand how rain affects friction and braking distance. 3. Develop defensive driving anticipation skills.",
                    knowledge: [{ title: "Blind Spots", desc: "Inner wheel difference." }, { title: "Friction", desc: "Wet roads." }, { title: "Defensive Driving", desc: "Anticipate errors." }],
                    skills: [{ title: "Braking", desc: "ABS control." }, { title: "Scanning", desc: "Check mirrors." }, { title: "Blind Spot", desc: "Shoulder check." }],
                    attitude: [{ title: "Aversion", desc: "Safe routes." }, { title: "Patience", desc: "Yielding." }, { title: "Monitoring", desc: "Rest if tired." }],
                    glossary: [
                        { term: "Inner Wheel Difference", def: "Difference in tracks between inner front and rear wheels during a turn." },
                        { term: "Defensive Driving", def: "Anticipating potential hazards and taking preemptive action." },
                        { term: "Blind Spot", def: "Areas not seen via mirrors, requiring a shoulder check." },
                        { term: "Aquaplaning", def: "Loss of traction due to water layer between tires and road." },
                        { term: "Reaction Time", def: "Time from perception to action." },
                        { term: "Braking Distance", def: "Distance traveled during braking." },
                        { term: "Safety Distance", def: "Gap between vehicles." },
                        { term: "A-Pillar Blind Spot", def: "Obstruction by windshield pillars." },
                        { term: "Right of Way", def: "Legal priority to proceed." },
                        { term: "Rear-end Collision", def: "Hitting vehicle from behind." }
                    ],
                    quizPool: [{ q: "Truck danger zone?", options: ["Behind", "Inner wheel", "Left"], ans: 1 }, { q: "Wet lines?", options: ["Brake", "Straight", "Lean"], ans: 1 }, { q: "Defensive driving?", options: ["Expect errors", "Speed", "Selfish"], ans: 0 }, { q: "Turning Truck?", options: ["Pass", "Stay back", "Parallel"], ans: 1 }]
                }
            },
            guidelines: {
                zh: {
                    title: "安全指引", 
                    summary: "彙整標準作業程序 (SOP) 與交通法規。重點包含：1. 絕對遵守路權優先順序（轉彎讓直行、支道讓幹道）。2. 落實行前車輛檢查（五油三水、胎紋）。3. 正確使用燈號溝通與配戴合格防護裝備。",
                    knowledge: [{ title: "路權", desc: "轉彎讓直行。" }, { title: "速限", desc: "法規為上限。" }, { title: "號誌", desc: "閃紅燈停車。" }],
                    skills: [{ title: "裝備", desc: "戴好安全帽。" }, { title: "檢查", desc: "五油三水。" }, { title: "燈號", desc: "提早打燈。" }],
                    attitude: [{ title: "守法", desc: "遵守規則。" }, { title: "禮讓", desc: "禮讓行人。" }, { title: "責任", desc: "不酒駕。" }],
                    glossary: [
                        { term: "停讓 (Stop/Yield)", def: "完全停止再開。" },
                        { term: "兩段式左轉 (Two-stage Left)", def: "機車需進入待轉區等待。" },
                        { term: "雙黃線 (Double Yellow)", def: "嚴禁跨越或迴轉。" },
                        { term: "閃光紅燈", def: "視同『停車再開』標誌。" },
                        { term: "閃光黃燈", def: "需減速接近，注意安全。" },
                        { term: "圓環 (Roundabout)", def: "禮讓環內車輛先行。" },
                        { term: "路肩 (Shoulder)", def: "道路外側供緊急停車使用之區域，非緊急狀況不得行駛。" },
                        { term: "讓路線 (Yield Line)", def: "倒三角形標線，表示駕駛人應減速或停車，禮讓幹道車先行。" },
                        { term: "全罩式安全帽 (Full-face Helmet)", def: "包覆頭部與下巴的安全帽，提供最佳防護力。" },
                        { term: "五油三水", def: "車輛檢查口訣：汽油、機油、變速箱油、煞車油、動力方向機油；水箱水、雨刷水、電瓶水。" },
                        { term: "絕對路權", def: "行人穿越道上的行人擁有優先通行權，車輛必須絕對禮讓。" }
                    ],
                    quizPool: [{ q: "閃紅燈?", options: ["減速", "停車", "加速"], ans: 1 }, { q: "雙黃線?", options: ["超車", "禁跨越", "迴轉"], ans: 1 }, { q: "禮讓行人?", options: ["鳴笛", "繞過", "暫停"], ans: 2 }, { q: "圓環?", options: ["讓環內", "搶快", "隨意"], ans: 0 }]
                },
                en: {
                    title: "Safety Guidelines", 
                    summary: "Standard Operating Procedures (SOP) and traffic laws. Key points: 1. Strictly follow Right of Way rules (Straight > Turning). 2. Conduct pre-trip vehicle checks (fluids, tires). 3. Correct use of signals and protective gear.",
                    knowledge: [{ title: "Right of Way", desc: "Yield to straight." }, { title: "Limits", desc: "Max speed." }, { title: "Signals", desc: "Stop on flashing red." }],
                    skills: [{ title: "Gear", desc: "Helmet on." }, { title: "Check", desc: "Pre-ride check." }, { title: "Signal", desc: "Early blinker." }],
                    attitude: [{ title: "Law", desc: "Follow rules." }, { title: "Respect", desc: "Pedestrians." }, { title: "Duty", desc: "No DUI." }],
                    glossary: [
                        { term: "Stop/Yield", def: "Full stop." },
                        { term: "Box Turn", def: "Two-stage left." },
                        { term: "Double Yellow", def: "No crossing." },
                        { term: "Flashing Red", def: "Stop and go." },
                        { term: "Flashing Yellow", def: "Slow down." },
                        { term: "Roundabout", def: "Yield to circle." },
                        { term: "Shoulder", def: "Emergency only." },
                        { term: "Yield Line", def: "Indicates necessity to yield to major road traffic." },
                        { term: "Full-face Helmet", def: "Best protection." },
                        { term: "Pre-trip Inspection", def: "Routine check of vehicle condition before driving." },
                        { term: "Pedestrian Priority", def: "Yield at crosswalks." }
                    ],
                    quizPool: [{ q: "Flashing Red?", options: ["Slow", "Stop", "Fast"], ans: 1 }, { q: "Double Yellow?", options: ["Pass", "No Cross", "U-turn"], ans: 1 }, { q: "Pedestrians?", options: ["Honk", "Round", "Stop"], ans: 2 }, { q: "Roundabout?", options: ["Yield", "Go", "Stop"], ans: 0 }]
                }
            },
            capability: {
                zh: {
                    title: "安全能力", 
                    summary: "評估駕駛人生理與心理狀態。重點包含：1. 自我覺察疲勞徵兆（如微睡眠）並立即休息。2. 了解抗組織胺等藥物對反應速度的副作用。3. 掌握車輛在雙載或載重時的操控極限差異。",
                    knowledge: [{ title: "疲勞", desc: "微睡眠危險。" }, { title: "藥物", desc: "感冒藥嗜睡。" }, { title: "極限", desc: "載重影響煞車。" }],
                    skills: [{ title: "閃避", desc: "不看障礙物。" }, { title: "穩定", desc: "夾緊油箱。" }, { title: "空間", desc: "判斷車寬。" }],
                    attitude: [{ title: "學習", desc: "持續進修。" }, { title: "誠實", desc: "評估狀態。" }, { title: "冷靜", desc: "情緒控制。" }],
                    glossary: [
                        { term: "反應時間", def: "察覺到行動的時間。" },
                        { term: "微睡眠 (Microsleep)", def: "極短暫失神，疲勞駕駛徵兆。" },
                        { term: "動態視力", def: "移動中辨識物體的能力。" },
                        { term: "預判力", def: "預測路況發展。" },
                        { term: "抗壓力", def: "遇突發狀況保持冷靜。" },
                        { term: "手眼協調", def: "操作精準度。" },
                        { term: "肌肉記憶", def: "熟練的操作反應。" },
                        { term: "空間感", def: "車輛體積與距離判斷。" },
                        { term: "酒測值 (BAC)", def: "血液酒精濃度，超過法規標準即為酒駕。" },
                        { term: "情緒駕駛 (Road Rage)", def: "因交通狀況產生的憤怒情緒，導致攻擊性駕駛行為。" },
                        { term: "隧道視野", def: "專注於單一點而忽略周邊環境的視覺現象，常發生於高速或緊張時。" }
                    ],
                    quizPool: [{ q: "吃感冒藥?", options: ["精神好", "嗜睡", "沒差"], ans: 1 }, { q: "長途休息?", options: ["4hr", "2hr", "免"], ans: 1 }, { q: "載人煞車?", options: ["變短", "變長", "不變"], ans: 1 }, { q: "微睡眠?", options: ["休息", "繼續", "喝咖啡"], ans: 0 }]
                },
                en: {
                    title: "Safety Capability", 
                    summary: "Evaluate physiological and psychological readiness. Key points: 1. Recognize fatigue signs (microsleep) and rest. 2. Understand side effects of meds like antihistamines. 3. Master vehicle handling limits under load.",
                    knowledge: [{ title: "Fatigue", desc: "Microsleep." }, { title: "Meds", desc: "Drowsiness." }, { title: "Limits", desc: "Load affects braking." }],
                    skills: [{ title: "Evasion", desc: "Look at exit." }, { title: "Stability", desc: "Grip tank." }, { title: "Space", desc: "Width judgment." }],
                    attitude: [{ title: "Learning", desc: "Update skills." }, { title: "Honesty", desc: "Self-assess." }, { title: "Calm", desc: "Control emotions." }],
                    glossary: [
                        { term: "Reaction Time", def: "Perception to action." },
                        { term: "Microsleep", def: "Brief blackout." },
                        { term: "Dynamic Vision", def: "Seeing while moving." },
                        { term: "Anticipation", def: "Prediction." },
                        { term: "Stress Tolerance", def: "Staying calm." },
                        { term: "Hand-eye Coord.", def: "Control sync." },
                        { term: "Muscle Memory", def: "Automatic reactions from practice." },
                        { term: "Spatial Awareness", def: "Distance judging." },
                        { term: "Tunnel Vision", def: "Narrow view." },
                        { term: "Side Effects", def: "Drowsiness from meds." }
                    ],
                    quizPool: [{ q: "Cold meds?", options: ["Alert", "Drowsy", "Same"], ans: 1 }, { q: "Rest interval?", options: ["4hr", "2hr", "None"], ans: 1 }, { q: "Passenger brake?", options: ["Short", "Long", "Same"], ans: 1 }, { q: "Microsleep?", options: ["Stop", "Go", "Coffee"], ans: 0 }]
                }
            }
        };

        const getSimulationData = (timeSlot) => {
            switch(timeSlot) {
                case '08:00': return { temp: 24, condition: "Partly Cloudy", icon: Sun, trafficLoad: 90, trafficStatus: "Rush Hour", isNight: false };
                case '12:00': return { temp: 32, condition: "Sunny", icon: Sun, trafficLoad: 60, trafficStatus: "Moderate", isNight: false };
                case '17:00': return { temp: 29, condition: "Cloudy", icon: Cloud, trafficLoad: 95, trafficStatus: "Heavy", isNight: false };
                case '22:00': return { temp: 22, condition: "Clear", icon: MoonIcon, trafficLoad: 20, trafficStatus: "Light", isNight: true };
                default:
                    const hour = new Date().getHours();
                    const isNightNow = hour >= 18 || hour < 6;
                    return { temp: 28, condition: isNightNow ? "Clear" : "Sunny", icon: isNightNow ? MoonIcon : Sun, trafficLoad: (hour >= 7 && hour <= 9) || (hour >= 17 && hour <= 19) ? 85 : 45, trafficStatus: "Normal", isNight: isNightNow };
            }
        };

        // --- Sub-Components ---

        const HeroSection = ({ isCompact = false, lang = 'zh' }) => {
            const t = UI_TEXT[lang];
            if (isCompact) {
                return (
                    <div className="flex flex-col justify-center bg-emerald-700 p-2 px-3 rounded-sm shadow-sm text-white w-fit">
                        <div className="flex items-center gap-2">
                            <Shield className="w-5 h-5 text-emerald-300" />
                            <h1 className="text-xl font-bold tracking-tight font-sans">RSA</h1>
                        </div>
                        <div className="text-emerald-100 font-bold text-[8px] tracking-widest uppercase whitespace-nowrap">ROAD SAFETY ADVISOR</div>
                    </div>
                );
            }
            return (
                <div className="flex flex-col items-center text-center transition-all duration-300">
                    <div className="text-slate-500 font-bold text-sm mb-2 tracking-wide">{t.brandSubtitle}</div>
                    <div className="flex items-center gap-2 mb-1"><Shield className="w-10 h-10 text-emerald-600" /><h1 className="text-4xl font-bold tracking-tight text-slate-800 dark:text-white font-sans">RSA</h1></div>
                    <div className="text-emerald-700 dark:text-emerald-400 font-semibold text-sm tracking-widest uppercase mb-2">Road Safety Advisor</div>
                    <h2 className="text-xl font-medium text-slate-600 dark:text-slate-300 italic serif">"{t.slogan}"</h2>
                    <p className="text-sm text-slate-500 dark:text-slate-400 mt-1 font-medium">{t.valueProp}</p>
                </div>
            );
        };

        const FlipCard = ({ item, lang, isOpen, onToggle }) => {
            const t = UI_TEXT[lang];
            return (
                <div 
                    className="relative w-full h-32 cursor-pointer group"
                    onClick={(e) => {
                        if (!isOpen) {
                            e.stopPropagation();
                            onToggle();
                        }
                    }}
                    style={{ perspective: '1000px' }}
                >
                    <div 
                        className="w-full h-full transition-all duration-500"
                        style={{ 
                            transformStyle: 'preserve-3d',
                            transform: isOpen ? 'rotateY(180deg)' : 'rotateY(0deg)'
                        }}
                    >
                        <div 
                            className="absolute inset-0 bg-white dark:bg-slate-800 p-4 rounded-sm shadow-sm border-l-4 border-blue-500 flex flex-col justify-center items-center text-center"
                            style={{ backfaceVisibility: 'hidden', WebkitBackfaceVisibility: 'hidden' }}
                        >
                            <h4 className="font-bold text-slate-700 dark:text-slate-200 text-sm">{item.title}</h4>
                            <p className="text-[10px] text-blue-500 mt-2 flex items-center gap-1"><RotateCcw className="w-3 h-3" /> {t.flipHint}</p>
                        </div>
                        <div 
                            className="absolute inset-0 bg-blue-50 dark:bg-slate-700 p-4 rounded-sm shadow-sm border border-blue-200 dark:border-slate-600 flex items-center justify-center text-center"
                            style={{ 
                                backfaceVisibility: 'hidden', 
                                WebkitBackfaceVisibility: 'hidden',
                                transform: 'rotateY(180deg)' 
                            }}
                        >
                            <p className="text-xs text-slate-600 dark:text-slate-200 pointer-events-none">{item.desc}</p>
                        </div>
                    </div>
                </div>
            );
        };

        const ThermometerWidget = ({ lang, data }) => (
            <div className="flex flex-col items-center justify-center p-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-sm shadow-sm h-full w-full relative overflow-hidden">
                <div className="w-full flex justify-between items-center mb-2 z-10">
                    <div className="flex items-center gap-1"><data.icon className={`w-4 h-4 ${data.isNight ? 'text-blue-400' : 'text-amber-500'}`} /><span className="text-[10px] font-bold text-slate-500 uppercase">{UI_TEXT[lang].weather}</span></div>
                    <div className="text-sm font-bold text-slate-700 dark:text-slate-200">{data.temp}°C</div>
                </div>
                <div className="w-full bg-slate-100 dark:bg-slate-700 h-2 rounded-full overflow-hidden border border-slate-200 z-10">
                    <div 
                        className={`h-full transition-all duration-1000 ${data.temp > 30 ? 'bg-red-500' : 'bg-amber-400'}`}
                        style={{ width: `${(data.temp / 45) * 100}%` }}
                    ></div>
                </div>
                <div className="w-full text-right mt-1 text-[10px] text-slate-500 z-10">{data.condition}</div>
            </div>
        );

        const TrafficGauge = ({ lang, data }) => (
            <div className="flex flex-col items-center justify-center p-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-sm shadow-sm h-full w-full relative overflow-hidden">
                <div className="w-full flex justify-between items-center mb-1 z-10">
                    <div className="flex items-center gap-1"><Gauge className="w-4 h-4 text-emerald-500" /><span className="text-[10px] font-bold text-slate-500 uppercase">{UI_TEXT[lang].traffic}</span></div>
                    <div className={`text-sm font-bold ${data.trafficLoad > 80 ? 'text-red-500' : 'text-emerald-500'}`}>{data.trafficLoad}%</div>
                </div>
                <div className="w-full flex gap-1 h-2 mt-1 z-10">
                    {[...Array(5)].map((_, i) => (
                        <div 
                            key={i} 
                            className={`flex-1 rounded-sm transition-colors duration-500 ${
                                i < (data.trafficLoad / 20) 
                                ? (data.trafficLoad > 80 ? 'bg-red-500' : data.trafficLoad > 50 ? 'bg-amber-400' : 'bg-emerald-400') 
                                : 'bg-slate-100 dark:bg-slate-700'
                            }`}
                        ></div>
                    ))}
                </div>
                <div className="w-full text-right mt-1 text-[10px] text-slate-500 z-10">{data.trafficStatus}</div>
            </div>
        );

        const MapComponent = ({ lang, transport, waypoints, mapScale, isNight, trafficLoad, startLoc, endLoc, mapMode, setMapMode, school }) => {
            const t = UI_TEXT[lang];
            const [viewState, setViewState] = useState({ x: 0, y: 0, scale: 1.5 });
            const [isDragging, setIsDragging] = useState(false);
            const [lastPos, setLastPos] = useState({ x: 0, y: 0 });
            const [showHotspots, setShowHotspots] = useState(false); // Toggle for hotspots
            const containerRef = useRef(null);
            
            // Refs for Leaflet Map
            const mapRef = useRef(null); // Container DIV
            const leafletMap = useRef(null); // Map Instance
            const polylineRef = useRef(null);
            const markersRef = useRef([]);
            const hotspotLayerRef = useRef(L.layerGroup()); // Layer group for hotspots

            // Get coords based on selected school
            const currentCoords = useMemo(() => {
                return SCHOOL_COORDS[school] || SCHOOL_COORDS[DEFAULT_SCHOOL];
            }, [school]);

            // --- Generate Random Hotspots around current school ---
            const hotspots = useMemo(() => {
                const spots = [];
                for(let i=0; i<8; i++) {
                    const latOffset = (Math.random() - 0.5) * 0.01;
                    const lonOffset = (Math.random() - 0.5) * 0.01;
                    const severity = Math.random() > 0.7 ? 'high' : 'medium';
                    spots.push({
                        lat: currentCoords.lat + latOffset,
                        lon: currentCoords.lon + lonOffset,
                        severity,
                        count: Math.floor(Math.random() * 20) + 5
                    });
                }
                return spots;
            }, [currentCoords]);
            
            // --- Helper to get lat/lon for start/end based on school center ---
            const getPointCoords = (locationStr) => {
                const base = currentCoords;
                if (locationStr.includes("Gate") || locationStr.includes("校門")) return base;
                if (locationStr.includes("Dorm") || locationStr.includes("宿舍")) return { lat: base.lat + 0.002, lon: base.lon - 0.002 };
                if (locationStr.includes("Admin") || locationStr.includes("行政")) return { lat: base.lat - 0.002, lon: base.lon + 0.001 };
                
                if (locationStr.includes("Station") || locationStr.includes("轉運")) return { lat: base.lat - 0.015, lon: base.lon + 0.01 };
                if (locationStr.includes("City") || locationStr.includes("市區")) return { lat: base.lat + 0.02, lon: base.lon - 0.015 };
                if (locationStr.includes("Train") || locationStr.includes("火車")) return { lat: base.lat - 0.03, lon: base.lon + 0.02 };
                
                return base; 
            };

            const startPoint = useMemo(() => getPointCoords(startLoc), [startLoc, currentCoords]);
            const endPoint = useMemo(() => getPointCoords(endLoc), [endLoc, currentCoords]);

            // --- Traffic Color Logic (Shared) ---
            const getTrafficColor = (load) => {
                if (load > 80) return '#ef4444'; // Red
                if (load > 60) return '#f59e0b'; // Amber
                return '#10b981'; // Green
            };
            const trafficColor = getTrafficColor(trafficLoad);
            const trafficText = trafficLoad > 80 ? (lang === 'zh' ? '壅塞' : 'Heavy') : trafficLoad > 60 ? (lang === 'zh' ? '車多' : 'Moderate') : (lang === 'zh' ? '順暢' : 'Smooth');
            
            // --- Marker HTML Generators (SVG) ---
            const startMarkerHtml = `
                <div class="relative w-8 h-8 flex flex-col items-center justify-center">
                   <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#16a34a" class="w-10 h-10 drop-shadow-md">
                     <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/>
                   </svg>
                   <div class="absolute top-2 left-1/2 transform -translate-x-1/2 w-4 h-4 flex items-center justify-center">
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" class="w-3 h-3">
                        <path d="M13.73 4a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
                     </svg>
                   </div>
                </div>
            `;
            const endMarkerHtml = `
                 <div class="relative w-8 h-8 flex flex-col items-center justify-center">
                   <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#dc2626" class="w-10 h-10 drop-shadow-md">
                     <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/>
                   </svg>
                   <div class="absolute top-2 left-1/2 transform -translate-x-1/2 w-4 h-4 flex items-center justify-center">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" class="w-2.5 h-2.5">
                         <rect width="18" height="18" x="3" y="3" rx="2"/>
                      </svg>
                   </div>
                </div>
            `;

            // --- Leaflet Map Effect ---
            useEffect(() => {
                if (mapMode === 'real' && mapRef.current) {
                    if (!leafletMap.current) {
                        leafletMap.current = L.map(mapRef.current, {zoomControl: false}).setView([currentCoords.lat, currentCoords.lon], 15);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; OpenStreetMap contributors'
                        }).addTo(leafletMap.current);
                        hotspotLayerRef.current.addTo(leafletMap.current); // Add layer group
                    } else {
                        leafletMap.current.setView([currentCoords.lat, currentCoords.lon]);
                    }

                    if (polylineRef.current) polylineRef.current.remove();
                    markersRef.current.forEach(m => m.remove());
                    markersRef.current = [];
                    hotspotLayerRef.current.clearLayers(); // Clear old hotspots

                    const startIcon = L.divIcon({ html: startMarkerHtml, className: 'custom-pin', iconSize: [40, 40], iconAnchor: [20, 40], popupAnchor: [0, -40] });
                    const endIcon = L.divIcon({ html: endMarkerHtml, className: 'custom-pin', iconSize: [40, 40], iconAnchor: [20, 40], popupAnchor: [0, -40] });

                    const startMarker = L.marker([startPoint.lat, startPoint.lon], {icon: startIcon}).addTo(leafletMap.current)
                        .bindPopup(`${t.start}: ${startLoc.split('(')[0]}`).openPopup();
                    markersRef.current.push(startMarker);

                    const endMarker = L.marker([endPoint.lat, endPoint.lon], {icon: endIcon}).addTo(leafletMap.current)
                        .bindPopup(`${t.end}: ${endLoc.split('(')[0]}`);
                    markersRef.current.push(endMarker);

                    const latlngs = [[startPoint.lat, startPoint.lon], [endPoint.lat, endPoint.lon]];
                    
                    // Route Line Style based on Traffic and Transport
                    const dashArray = transport === 'walk' ? '10, 10' : null;
                    polylineRef.current = L.polyline(latlngs, {
                        color: trafficColor, 
                        weight: 6, 
                        opacity: 0.8,
                        dashArray: dashArray
                    }).addTo(leafletMap.current);
                    
                    leafletMap.current.fitBounds(latlngs, { padding: [50, 50] });

                    // Render Hotspots if enabled
                    if (showHotspots) {
                        hotspots.forEach(spot => {
                             L.circle([spot.lat, spot.lon], {
                                color: spot.severity === 'high' ? 'red' : 'orange',
                                fillColor: spot.severity === 'high' ? '#f03' : '#f90',
                                fillOpacity: 0.5,
                                radius: spot.count * 10
                            }).addTo(hotspotLayerRef.current)
                            .bindPopup(`Accidents: ${spot.count}`);
                        });
                    }
                    
                    if (isNight) {
                         const pane = document.querySelector('.leaflet-tile-pane');
                         if(pane) pane.style.filter = "invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%)";
                    } else {
                         const pane = document.querySelector('.leaflet-tile-pane');
                         if(pane) pane.style.filter = "none";
                    }
                } else {
                    if (leafletMap.current) {
                        leafletMap.current.remove();
                        leafletMap.current = null;
                        hotspotLayerRef.current.clearLayers();
                    }
                }
            }, [mapMode, currentCoords, startPoint, endPoint, trafficColor, isNight, lang, transport, showHotspots, hotspots]);


            // --- Sim Mode Logic ---
            useEffect(() => {
                let newScale = 1.5;
                if (mapScale === 100) newScale = 2.5;
                if (mapScale === 300) newScale = 1.5;
                if (mapScale === 1000) newScale = 0.8;
                setViewState(prev => ({ ...prev, scale: newScale }));
            }, [mapScale]);

            const handleZoomIn = () => {
                if (mapMode === 'real' && leafletMap.current) {
                    leafletMap.current.zoomIn();
                } else {
                    setViewState(prev => ({ ...prev, scale: Math.min(prev.scale + 0.5, 5) }));
                }
            };

            const handleZoomOut = () => {
                if (mapMode === 'real' && leafletMap.current) {
                    leafletMap.current.zoomOut();
                } else {
                    setViewState(prev => ({ ...prev, scale: Math.max(prev.scale - 0.5, 0.5) }));
                }
            };

            const handleWheel = (e) => { e.preventDefault(); e.stopPropagation(); const scaleAdjustment = -e.deltaY * 0.001; setViewState(prev => ({ ...prev, scale: Math.min(Math.max(prev.scale + scaleAdjustment, 0.5), 5) })); };
            const handleMouseDown = (e) => { setIsDragging(true); setLastPos({ x: e.clientX, y: e.clientY }); };
            const handleMouseMove = (e) => { if (!isDragging) return; const dx = e.clientX - lastPos.x; const dy = e.clientY - lastPos.y; setViewState(prev => ({ ...prev, x: prev.x + dx, y: prev.y + dy })); setLastPos({ x: e.clientX, y: e.clientY }); };
            const handleMouseUp = () => setIsDragging(false);

            // Sim Mode Styles
            const roadStroke = trafficColor;
            const mainRoadStroke = trafficLoad > 80 ? '#ef4444' : trafficLoad > 60 ? '#f59e0b' : (isNight ? '#475569' : '#fff');
            const startPosSim = startLoc.includes("Gate") || startLoc.includes("校門") ? { top: '55%', left: '45%' } : { top: '65%', left: '35%' };
            const endPosSim = endLoc.includes("Station") || endLoc.includes("轉運") ? { top: '35%', left: '65%' } : { top: '25%', left: '75%' };

            return (
                <div className={`border border-slate-300 dark:border-slate-600 rounded-sm w-full h-[400px] relative overflow-hidden group transition-colors duration-500 ${isNight ? 'bg-slate-900' : 'bg-slate-100'}`} style={{ overscrollBehavior: 'contain' }}>
                    <div className="absolute top-2 left-2 z-40 flex bg-white/90 dark:bg-slate-800/90 rounded border border-slate-300 dark:border-slate-600 p-0.5">
                        <button onClick={() => setMapMode('real')} className={`px-2 py-1 text-[10px] font-bold rounded-sm ${mapMode === 'real' ? 'bg-emerald-600 text-white' : 'text-slate-500'}`}>{t.mapModeReal}</button>
                        <button onClick={() => setMapMode('sim')} className={`px-2 py-1 text-[10px] font-bold rounded-sm ${mapMode === 'sim' ? 'bg-emerald-600 text-white' : 'text-slate-500'}`}>{t.mapModeSim}</button>
                    </div>

                    {/* Hotspot Toggle */}
                     <div className="absolute top-2 right-2 z-40">
                         <button 
                             onClick={() => setShowHotspots(!showHotspots)} 
                             className={`px-2 py-1 text-[10px] font-bold rounded border border-slate-300 dark:border-slate-600 shadow-sm ${showHotspots ? 'bg-red-600 text-white' : 'bg-white/90 text-slate-600 dark:bg-slate-800/90 dark:text-slate-300'}`}
                         >
                            {t.showHotspots}
                         </button>
                     </div>


                    {mapMode === 'real' ? (
                        <div id="map" ref={mapRef} className="w-full h-full z-0"></div>
                    ) : (
                        <>
                            <div ref={containerRef} className="w-full h-full cursor-move touch-none" onWheel={handleWheel} onMouseDown={handleMouseDown} onMouseMove={handleMouseMove} onMouseUp={handleMouseUp} onMouseLeave={handleMouseUp}>
                                <div className="w-full h-full absolute inset-0 transition-transform duration-75 ease-out origin-center flex items-center justify-center" style={{ transform: `translate(${viewState.x}px, ${viewState.y}px) scale(${viewState.scale})` }}>
                                    <div className="absolute inset-[-100%] bg-slate-50 dark:bg-slate-900 opacity-100">
                                        <div className="absolute inset-0" style={{ backgroundImage: `linear-gradient(${isNight ? '#1e293b' : '#cbd5e1'} 1px, transparent 1px), linear-gradient(90deg, ${isNight ? '#1e293b' : '#cbd5e1'} 1px, transparent 1px)`, backgroundSize: '40px 40px' }}></div>
                                        <div className="absolute top-[20%] left-[60%] w-[500px] h-[500px] bg-blue-200/50 dark:bg-blue-900/30 rounded-full blur-3xl pointer-events-none"></div>
                                        <svg className="absolute inset-0 w-full h-full pointer-events-none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M-500,800 Q400,400 1200,800 T2400,400" fill="none" stroke={mainRoadStroke} strokeWidth="50" strokeLinecap="round" className="transition-colors duration-1000" />
                                            <path d="M800,-400 Q900,400 800,1200" fill="none" stroke={roadStroke} strokeWidth="45" strokeLinecap="round" className="transition-colors duration-1000" />
                                            <path d="M200,200 L1600,1000" fill="none" stroke={trafficLoad > 60 ? roadStroke : (isNight ? "#1e293b" : "#e2e8f0")} strokeWidth="25" />
                                            <path d="M1600,200 L200,1000" fill="none" stroke={trafficLoad > 60 ? trafficColor : (isNight ? "#1e293b" : "#e2e8f0")} strokeWidth="25" />
                                            <path d="M700,500 L900,300" fill="none" stroke={trafficLoad > 80 ? '#ef4444' : '#10b981'} strokeWidth="8" strokeDasharray="12 6" strokeLinecap="round" className="animate-[dash_20s_linear_infinite]" />
                                            
                                            {/* Simulated Hotspots (Pulse Circles at Intersections) */}
                                            {showHotspots && (
                                                <>
                                                    <circle cx="800" cy="400" r="40" fill="rgba(239, 68, 68, 0.5)" className="hotspot-pulse" />
                                                    <circle cx="1600" cy="800" r="30" fill="rgba(245, 158, 11, 0.5)" />
                                                    <circle cx="200" cy="200" r="25" fill="rgba(239, 68, 68, 0.5)" className="hotspot-pulse" />
                                                </>
                                            )}
                                        </svg>
                                    </div>
                                    <div className="absolute transform -translate-x-1/2 -translate-y-1/2 z-20 flex flex-col items-center pointer-events-none" style={startPosSim}>
                                        <div className="relative"><MapPin className="w-12 h-12 text-green-600 fill-green-600 filter drop-shadow-lg" /><div className="absolute top-1 left-1/2 transform -translate-x-1/2 w-6 h-6 flex items-center justify-center"><Triangle className="w-5 h-5 text-white fill-white" /></div></div>
                                        <span className="text-[10px] font-bold bg-white/90 dark:bg-slate-800/90 text-slate-800 dark:text-white px-2 py-0.5 rounded shadow mt-1 whitespace-nowrap">{t.start}: {startLoc.split('(')[0]}</span>
                                    </div>
                                    <div className="absolute transform -translate-x-1/2 -translate-y-1/2 z-20 flex flex-col items-center pointer-events-none" style={endPosSim}>
                                        <div className="relative"><MapPin className="w-12 h-12 text-red-600 fill-red-600 filter drop-shadow-lg" /><div className="absolute top-1 left-1/2 transform -translate-x-1/2 w-6 h-6 flex items-center justify-center"><Square className="w-4 h-4 text-white fill-white" /></div></div>
                                        <span className="text-[10px] font-bold bg-white/90 dark:bg-slate-800/90 text-slate-800 dark:text-white px-2 py-0.5 rounded shadow mt-1 whitespace-nowrap">{t.end}: {endLoc.split('(')[0]}</span>
                                    </div>
                                    {waypoints.map((wp, idx) => (
                                        <div key={wp.id} className="absolute z-20 flex flex-col items-center pointer-events-none" style={{ top: `${45 + idx * 5}%`, left: `${50 + idx * 5}%` }}>
                                            <MapPin className="w-6 h-6 text-blue-500 fill-blue-500" />
                                            <span className="text-[9px] bg-white/80 px-1 rounded mt-0.5">{t.mapStop} {idx + 1}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </>
                    )}
                    {mapMode === 'sim' && <div className="absolute top-2 right-12 text-[9px] text-slate-500 bg-white/80 px-1 rounded z-30 pointer-events-none flex items-center gap-1"><MousePointer2 className="w-3 h-3"/> {t.mapSimNote}</div>}
                    
                    {/* Traffic Status Indicator - Bottom Center */}
                    <div className="absolute bottom-2 left-1/2 transform -translate-x-1/2 z-40 flex items-center gap-2 bg-white/95 dark:bg-slate-800/95 px-3 py-1 rounded-full shadow-md border border-slate-200 dark:border-slate-600 pointer-events-none">
                        <div className="w-2.5 h-2.5 rounded-full shadow-sm" style={{ backgroundColor: trafficColor }}></div>
                        <span className="text-[10px] font-bold text-slate-700 dark:text-slate-200">{t.trafficLabel}: {trafficText}</span>
                    </div>
                    
                    {/* Unified Zoom Buttons for BOTH modes */}
                    <div className="absolute bottom-4 right-4 flex flex-col gap-1 z-50">
                        <button onClick={handleZoomIn} className="bg-white/90 dark:bg-slate-800/90 p-1.5 rounded border border-slate-300 dark:border-slate-600 shadow hover:bg-slate-100 dark:hover:bg-slate-700"><ZoomIn className="w-4 h-4 text-slate-700 dark:text-white" /></button>
                        <button onClick={handleZoomOut} className="bg-white/90 dark:bg-slate-800/90 p-1.5 rounded border border-slate-300 dark:border-slate-600 shadow hover:bg-slate-100 dark:hover:bg-slate-700"><ZoomOut className="w-4 h-4 text-slate-700 dark:text-white" /></button>
                    </div>

                    <div className="absolute bottom-4 left-4 p-3 bg-white/90 dark:bg-slate-800/90 rounded-full border border-slate-300 dark:border-slate-600 shadow-md z-30 pointer-events-none">
                        {transport === 'walk' && <User className="w-6 h-6 text-slate-700 dark:text-white" />}
                        {transport === 'bike' && <Bike className="w-6 h-6 text-slate-700 dark:text-white" />}
                        {transport === 'scooter' && <ScooterIcon className="w-6 h-6 text-slate-700 dark:text-white" />}
                        {transport === 'car' && <Car className="w-6 h-6 text-slate-700 dark:text-white" />}
                        {transport === 'bus' && <Bus className="w-6 h-6 text-slate-700 dark:text-white" />}
                    </div>
                    {isNight && <div className="absolute inset-0 bg-blue-900/30 pointer-events-none z-10 mix-blend-multiply"></div>}
                </div>
            );
        };

        const OfficialResources = ({ lang }) => {
            const t = UI_TEXT[lang];
            const chartData = [120, 115, 118, 110, 105, 98, 92];
            return (
                <div className="space-y-6">
                    <div className="bg-white dark:bg-slate-800 p-6 rounded-sm shadow-sm border-l-4 border-blue-600">
                        <h3 className="text-lg font-bold text-slate-800 dark:text-white mb-2 flex items-center gap-2"><Building className="w-5 h-5 text-blue-600" /> {t.officialTitle}</h3>
                        <p className="text-sm text-slate-600 dark:text-slate-300 mb-4">{t.officialChartTitle}</p>
                        <div className="h-48 w-full flex items-end justify-between gap-2 border-b border-slate-300 pb-2 px-2">
                            {chartData.map((val, i) => (
                                <div key={i} className="flex flex-col items-center justify-end h-full flex-1 group">
                                    <div className="w-full bg-blue-200 dark:bg-blue-900 group-hover:bg-blue-300 transition-all rounded-t-sm relative" style={{ height: `${(val / 150) * 100}%` }}>
                                        <span className="absolute -top-5 left-1/2 transform -translate-x-1/2 text-[10px] font-bold text-slate-500 opacity-0 group-hover:opacity-100 transition-opacity">{val}</span>
                                    </div>
                                    <span className="text-[10px] text-slate-400 mt-1">201{7+i}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-white dark:bg-slate-800 p-6 rounded-sm shadow-sm border border-slate-200 dark:border-slate-700">
                            <h4 className="font-bold text-slate-700 dark:text-slate-200 mb-4 flex items-center gap-2"><ExternalLink className="w-4 h-4" /> {t.officialLinks} (Central)</h4>
                            <ul className="space-y-3 text-sm">
                                <li><a href="#" className="text-blue-600 hover:underline flex items-center gap-2"><ArrowRight className="w-3 h-3"/> 交通部 (MOTC)</a></li>
                                <li><a href="#" className="text-blue-600 hover:underline flex items-center gap-2"><ArrowRight className="w-3 h-3"/> 168交通安全入口網</a></li>
                                <li><a href="#" className="text-blue-600 hover:underline flex items-center gap-2"><ArrowRight className="w-3 h-3"/> 交通部公路局</a></li>
                                <li><a href="#" className="text-blue-600 hover:underline flex items-center gap-2"><ArrowRight className="w-3 h-3"/> 道安資訊查詢網</a></li>
                            </ul>
                        </div>
                        <div className="bg-white dark:bg-slate-800 p-6 rounded-sm shadow-sm border border-slate-200 dark:border-slate-700">
                            <h4 className="font-bold text-slate-700 dark:text-slate-200 mb-4 flex items-center gap-2"><ExternalLink className="w-4 h-4" /> {t.officialLinks} (Local)</h4>
                            <ul className="space-y-3 text-sm">
                                <li><a href="#" className="text-emerald-600 hover:underline flex items-center gap-2"><ArrowRight className="w-3 h-3"/> 台北市交通局</a></li>
                                <li><a href="#" className="text-emerald-600 hover:underline flex items-center gap-2"><ArrowRight className="w-3 h-3"/> 新北市交通局</a></li>
                                <li><a href="#" className="text-emerald-600 hover:underline flex items-center gap-2"><ArrowRight className="w-3 h-3"/> 台中市交通局</a></li>
                                <li><a href="#" className="text-emerald-600 hover:underline flex items-center gap-2"><ArrowRight className="w-3 h-3"/> 高雄市交通局</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            );
        };

        const LearningRecord = ({ t, progress, handleExportCSV, userName, school, currentDateTime, lang }) => (
            <div className="space-y-6">
                <div className="bg-white dark:bg-slate-800 p-6 rounded-sm shadow-sm border-l-4 border-emerald-500">
                    <div className="flex justify-between items-start mb-4">
                        <h3 className="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2"><User className="w-5 h-5 text-emerald-600" /> {t.userProfile}</h3>
                        <button onClick={handleExportCSV} className="text-xs flex items-center gap-1 bg-emerald-600 text-white px-3 py-1.5 rounded hover:bg-emerald-700 transition-colors"><Download className="w-3 h-3" /> {t.exportCSV}</button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div><span className="text-slate-500 block text-xs uppercase font-bold">{t.username}</span><span className="text-slate-800 dark:text-slate-200 font-medium text-lg">{userName}</span></div>
                        <div><span className="text-slate-500 block text-xs uppercase font-bold">{t.selectSchool}</span><span className="text-slate-800 dark:text-slate-200">{school}</span></div>
                        <div><span className="text-slate-500 block text-xs uppercase font-bold">{t.loginTime}</span><span className="text-slate-800 dark:text-slate-200">{lang === 'zh' ? currentDateTime.toLocaleString('zh-TW') : currentDateTime.toLocaleString('en-US')}</span></div>
                    </div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    {['risk', 'guidelines', 'capability'].map((key) => {
                        const item = progress[key];
                        const percent = Math.round((item.score / item.total) * 100) || 0;
                        const label = key === 'risk' ? UI_TEXT[lang].tabRisk : key === 'guidelines' ? UI_TEXT[lang].tabGuide : UI_TEXT[lang].tabCap;
                        const statusColor = percent === 100 ? 'text-emerald-600' : percent >= 60 ? 'text-amber-500' : 'text-red-500';
                        const statusText = percent === 100 ? t.statusHigh : percent >= 60 ? t.statusMid : t.statusLow;
                        return (
                            <div key={key} className="bg-white dark:bg-slate-800 p-6 rounded-sm shadow-sm border border-slate-200 dark:border-slate-700 flex flex-col items-center text-center">
                                <h4 className="font-bold text-slate-600 dark:text-slate-300 mb-4">{label}</h4>
                                <div className="relative w-24 h-24 flex items-center justify-center mb-4">
                                    <svg className="w-full h-full transform -rotate-90">
                                        <circle cx="48" cy="48" r="40" stroke="#e2e8f0" strokeWidth="8" fill="none" />
                                        <circle cx="48" cy="48" r="40" stroke="currentColor" strokeWidth="8" fill="none" className={statusColor} strokeDasharray="251.2" strokeDashoffset={251.2 - (251.2 * percent) / 100} />
                                    </svg>
                                    <span className={`absolute text-xl font-bold ${statusColor}`}>{percent}%</span>
                                </div>
                                <div className="w-full flex justify-between text-xs border-t border-slate-100 pt-3 mt-auto">
                                    <div className="text-slate-500">{t.score}: <span className="font-bold text-slate-800 dark:text-white">{item.score}/{item.total}</span></div>
                                    <div className="text-slate-500">{t.correctRate}: <span className={`font-bold ${statusColor}`}>{statusText}</span></div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            </div>
        );

        const LoginScreen = ({ lang, t, toggleLang, theme, toggleTheme, userName, setUserName, userEmail, setUserEmail, school, setSchool, handleLogin, links }) => (
            <div className={`min-h-screen flex flex-col items-center justify-center bg-slate-50 transition-colors duration-500 ${theme === 'dark' ? 'dark bg-slate-900' : ''}`}>
                <div className="w-full max-w-md bg-white dark:bg-slate-800 shadow-2xl rounded-sm overflow-hidden border-t-4 border-emerald-600">
                    <div className="bg-slate-100 dark:bg-slate-900 p-2 text-center text-xs text-slate-500 font-mono border-b border-slate-200 dark:border-slate-700">
                        {lang === 'zh' ? new Date().toLocaleString('zh-TW', { hour12: false }) : new Date().toLocaleString('en-US', { hour12: false })}
                    </div>
                    <div className="p-8 flex flex-col gap-6">
                        <HeroSection lang={lang} />
                        <div className="space-y-4 mt-4">
                            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">{t.username}</label><div className="flex items-center border border-slate-300 rounded-sm px-3 py-2 bg-slate-50 focus-within:ring-1 focus-within:ring-emerald-500"><User className="w-4 h-4 text-slate-400 mr-2" /><input type="text" value={userName} onChange={(e) => setUserName(e.target.value)} className="w-full bg-transparent outline-none text-slate-700 dark:text-slate-200 text-sm" placeholder={t.enterName} /></div></div>
                            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">{t.email}</label><div className="flex items-center border border-slate-300 rounded-sm px-3 py-2 bg-slate-50 focus-within:ring-1 focus-within:ring-emerald-500"><Mail className="w-4 h-4 text-slate-400 mr-2" /><input type="email" value={userEmail} onChange={(e) => setUserEmail(e.target.value)} className="w-full bg-transparent outline-none text-slate-700 dark:text-slate-200 text-sm" placeholder={t.enterEmail} /></div></div>
                            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">{t.selectSchool}</label><div className="relative"><select value={school} onChange={(e) => setSchool(e.target.value)} className="w-full appearance-none border border-slate-300 rounded-sm px-3 py-2 bg-slate-50 text-slate-700 dark:text-slate-200 text-sm pr-8 focus:ring-1 focus:ring-emerald-500 outline-none">{SCHOOLS.map(s => <option key={s} value={s}>{s}</option>)}</select><div className="absolute right-3 top-2.5 pointer-events-none"><ArrowRight className="w-4 h-4 text-slate-400 rotate-90" /></div></div></div>
                        </div>
                        <div className="space-y-3 mt-4">
                            {[{ id: 'risk', label: t.btnRisk }, { id: 'guidelines', label: t.btnGuide }, { id: 'capability', label: t.btnCap }, { id: 'record', label: t.btnRecord }, { id: 'official', label: t.btnOfficial }].map((btn) => (
                                <button key={btn.id} onClick={() => handleLogin(btn.id)} className="w-full group flex items-center justify-between px-4 py-3 bg-white border border-emerald-600 text-emerald-700 hover:bg-emerald-600 hover:text-white transition-all duration-200 rounded-sm shadow-sm">
                                    <span className="font-semibold text-sm">{btn.label}</span>
                                    <ArrowRight className="w-4 h-4 transform group-hover:translate-x-1 transition-transform" />
                                </button>
                            ))}
                        </div>
                        <div className="pt-6 border-t border-slate-100 dark:border-slate-700 text-center">
                            <div className="flex items-center justify-center gap-4 mb-4">
                                <button onClick={toggleLang} className="flex items-center gap-1 text-xs font-bold text-slate-500 hover:text-emerald-600 uppercase border px-2 py-1 rounded-sm cursor-pointer z-10"><Globe className="w-3 h-3" /> {lang === 'zh' ? 'EN' : '中'}</button>
                                <button onClick={toggleTheme} className="p-2 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full cursor-pointer z-10">{theme === 'light' ? <Moon className="w-4 h-4" /> : <SunIcon className="w-4 h-4" />}</button>
                            </div>
                            <a href={links.prof} target="_blank" rel="noopener noreferrer" className="text-xs text-slate-400 font-serif hover:text-emerald-600 transition-colors">{t.creator}</a>
                        </div>
                    </div>
                </div>
            </div>
        );

        const Dashboard = ({ activeTab, setActiveTab, lang, toggleLang, theme, toggleTheme, userName, school, currentDateTime, transport, setTransport, timeSlot, setTimeSlot, mapScale, setMapScale, startLocation, setStartLocation, endLocation, setEndLocation, waypoints, handleAddWaypoint, simData, progress, setProgress, pageData, handleLogout }) => {
            const t = UI_TEXT[lang];
            const [selectedGlossaryIndex, setSelectedGlossaryIndex] = useState("");
            const [mapMode, setMapMode] = useState('sim');
            const [openCardId, setOpenCardId] = useState(null);
            const [sections, setSections] = useState({ panel: true, map: true, content: true });
            const toggleSection = (sec) => setSections(prev => ({ ...prev, [sec]: !prev[sec] }));
            const [currentQuestions, setCurrentQuestions] = useState([]);
            const [quizAnswers, setQuizAnswers] = useState({});
            const [quizSubmitted, setQuizSubmitted] = useState(false);
            const [quizScore, setQuizScore] = useState(0);

            useEffect(() => {
                const handleGlobalClick = () => setOpenCardId(null);
                window.addEventListener('click', handleGlobalClick);
                return () => window.removeEventListener('click', handleGlobalClick);
            }, []);

            useEffect(() => {
                if (pageData && pageData.quizPool) {
                    const indices = getRandomIndices(pageData.quizPool.length, QUIZ_DISPLAY_COUNT);
                    setCurrentQuestions(indices.map(i => pageData.quizPool[i]));
                    setQuizAnswers({});
                    setQuizSubmitted(false);
                    setQuizScore(0);
                }
            }, [activeTab, lang, pageData]);

            const handleQuizSubmit = () => {
                let score = 0;
                currentQuestions.forEach((q, idx) => { if (quizAnswers[idx] === q.ans) score++; });
                setQuizScore(score);
                setQuizSubmitted(true);
                setProgress(prev => ({ ...prev, [activeTab]: { score: Math.max(prev[activeTab].score, score), total: 3, completed: true } }));
            };

            const activeGlossaryItem = selectedGlossaryIndex !== "" && pageData?.glossary ? pageData.glossary[selectedGlossaryIndex] : null;

            const handleExportCSV = () => {
                const headers = ['Subject (主題)', 'Score (得分)', 'Total (總分)', 'Completed (完成狀態)', 'Date (日期)'];
                const rows = Object.keys(progress).map(key => {
                    const p = progress[key];
                    const label = key === 'risk' ? UI_TEXT.zh.tabRisk : key === 'guidelines' ? UI_TEXT.zh.tabGuide : UI_TEXT.zh.tabCap;
                    return [label, p.score, p.total, p.completed ? 'Yes' : 'No', new Date().toLocaleDateString()].join(',');
                });
                const csvContent = '\uFEFF' + [headers.join(','), ...rows].join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `RSA_Learning_Record_${userName}_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            return (
                <div className={`min-h-screen flex flex-col bg-slate-50 dark:bg-slate-900 transition-colors duration-300 ${theme === 'dark' ? 'dark' : ''}`}>
                    <header className="bg-white dark:bg-slate-800 shadow-sm border-b border-emerald-600 sticky top-0 z-50">
                        <div className="container mx-auto px-4 py-2 flex justify-between items-center h-20">
                            <div onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })} className="cursor-pointer hover:opacity-90 transition-opacity">
                                <HeroSection isCompact={true} lang={lang} />
                            </div>
                            <div className="hidden md:flex flex-col items-center justify-center flex-grow px-8">
                                <h2 className="text-xl font-medium text-slate-700 dark:text-slate-200 italic serif">"{t.slogan}"</h2>
                                <div className="text-emerald-600 dark:text-emerald-400 font-semibold text-sm tracking-wide mt-1">{t.valueProp}</div>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="flex items-center gap-2">
                                    <button onClick={toggleLang} className="flex items-center gap-1 text-xs font-bold text-slate-600 dark:text-slate-300 hover:text-emerald-600 uppercase border px-2 py-1 rounded-sm cursor-pointer"><Globe className="w-3 h-3" /> {lang === 'zh' ? 'EN' : '中'}</button>
                                    <button onClick={toggleTheme} className="p-2 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full cursor-pointer">{theme === 'light' ? <Moon className="w-4 h-4" /> : <SunIcon className="w-4 h-4" />}</button>
                                    <button onClick={handleLogout} className="p-2 text-red-600 dark:text-red-400 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full cursor-pointer flex items-center gap-1"><LogOut className="w-4 h-4" /></button>
                                </div>
                                <div className="hidden lg:block text-right border-l border-slate-300 pl-4 ml-2">
                                    <div className="flex items-center justify-end gap-1 text-xs font-bold text-slate-700 dark:text-white"><User className="w-3 h-3" /> {userName}</div>
                                    <div className="text-[10px] text-slate-400 truncate max-w-[150px]">{school}</div>
                                </div>
                            </div>
                        </div>
                        <div className="bg-slate-50 dark:bg-slate-900 border-t border-slate-200 dark:border-slate-700 py-1">
                            <div className="container mx-auto px-4 flex gap-4 text-[10px] font-bold text-slate-500 uppercase">
                                <button onClick={() => toggleSection('panel')} className={`flex items-center gap-1 hover:text-emerald-600 ${!sections.panel && 'opacity-50'}`}>{sections.panel ? <Eye className="w-3 h-3"/> : <EyeOff className="w-3 h-3"/>} {t.togglePanel}</button>
                                <button onClick={() => toggleSection('map')} className={`flex items-center gap-1 hover:text-emerald-600 ${!sections.map && 'opacity-50'}`}>{sections.map ? <Eye className="w-3 h-3"/> : <EyeOff className="w-3 h-3"/>} {t.toggleMap}</button>
                                <button onClick={() => toggleSection('content')} className={`flex items-center gap-1 hover:text-emerald-600 ${!sections.content && 'opacity-50'}`}>{sections.content ? <Eye className="w-3 h-3"/> : <EyeOff className="w-3 h-3"/>} {t.toggleContent}</button>
                            </div>
                        </div>
                    </header>

                    {sections.panel && (
                        <div className="bg-slate-100 dark:bg-slate-950 border-b border-slate-200 dark:border-slate-800 p-4 animate-in slide-in-from-top-2">
                            <div className="container mx-auto grid grid-cols-1 md:grid-cols-12 gap-6">
                                <div className="md:col-span-3 grid grid-cols-1 gap-2 h-auto">
                                    <div className="h-28"><ThermometerWidget lang={lang} data={simData} /></div>
                                    <div className="h-28"><TrafficGauge lang={lang} data={simData} /></div>
                                </div>
                                <div className="md:col-span-9 flex flex-col gap-3 bg-white dark:bg-slate-800 p-5 rounded-sm border border-slate-200 dark:border-slate-700 shadow-sm h-full justify-center">
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block">{t.transport}</label>
                                            <div className="flex justify-between bg-slate-50 dark:bg-slate-900 p-1.5 rounded-sm border border-slate-200">
                                                {[{ id: 'walk', icon: User }, { id: 'bike', icon: Bike }, { id: 'scooter', icon: ScooterIcon }, { id: 'car', icon: Car }, { id: 'bus', icon: Bus }].map(type => (
                                                    <button key={type.id} onClick={() => setTransport(type.id)} className={`p-2 rounded-sm transition-all flex-1 flex justify-center ${transport === type.id ? 'bg-emerald-600 text-white shadow-sm' : 'text-slate-400 hover:text-emerald-600'}`}>
                                                        {type.id === 'scooter' ? <type.icon /> : <type.icon className="w-4 h-4" />}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block">{t.departureTime}</label>
                                            <div className="grid grid-cols-5 gap-2">
                                                {['08:00', '12:00', '17:00', '22:00', 'now'].map(slot => (
                                                    <button key={slot} onClick={() => setTimeSlot(slot)} className={`text-[10px] font-bold py-1.5 rounded-sm border ${timeSlot === slot ? 'border-emerald-600 text-emerald-700 bg-emerald-50' : 'border-slate-200 text-slate-500 hover:border-emerald-300'}`}>
                                                        {slot === 'now' ? 'NOW' : slot.split(':')[0]}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-6 border-t border-slate-100 pt-4 mt-2">
                                        <div className="flex gap-4">
                                            <div className="flex-1">
                                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 flex items-center gap-1"><MapPin className="w-3 h-3"/> {t.start}</label>
                                                <select value={startLocation} onChange={(e) => setStartLocation(e.target.value)} className="w-full text-xs p-2 rounded border border-slate-300 bg-white dark:bg-slate-700 dark:text-white dark:border-slate-600">
                                                    {LOCATIONS.start.map(l => <option key={l} value={l}>{l}</option>)}
                                                </select>
                                            </div>
                                            <div className="flex-1">
                                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 flex items-center gap-1"><MapPin className="w-3 h-3 text-red-500"/> {t.end}</label>
                                                <select value={endLocation} onChange={(e) => setEndLocation(e.target.value)} className="w-full text-xs p-2 rounded border border-slate-300 bg-white dark:bg-slate-700 dark:text-white dark:border-slate-600">
                                                    {LOCATIONS.end.map(l => <option key={l} value={l}>{l}</option>)}
                                                </select>
                                            </div>
                                        </div>
                                        <div className="flex items-end justify-between gap-4">
                                            <div className="flex-1">
                                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">{t.scale}</label>
                                                <select value={mapScale} onChange={(e) => setMapScale(Number(e.target.value))} className="w-full text-xs p-2 bg-slate-50 border border-slate-200 rounded-sm dark:bg-slate-700 dark:text-white dark:border-slate-600">
                                                    <option value={100}>1:100 (100m)</option>
                                                    <option value={300}>1:300 (300m)</option>
                                                    <option value={1000}>1:1000 (1km)</option>
                                                </select>
                                            </div>
                                            <button onClick={handleAddWaypoint} className="text-xs flex items-center justify-center gap-1 bg-emerald-50 text-emerald-700 px-4 py-2 rounded-sm border border-emerald-200 hover:bg-emerald-100 font-bold h-[34px]"><Plus className="w-3 h-3" /> {t.addStop}</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {sections.map && (
                        <div className="mx-[10%] p-4 animate-in fade-in zoom-in-95">
                            <MapComponent 
                                lang={lang} transport={transport} waypoints={waypoints} 
                                mapScale={mapScale} isNight={simData.isNight} trafficLoad={simData.trafficLoad}
                                startLoc={startLocation} endLoc={endLocation} mapMode={mapMode} setMapMode={setMapMode}
                                school={school}
                            />
                        </div>
                    )}

                    {sections.content && (
                        <>
                            <div className="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 shadow-sm">
                                <div className="container mx-auto px-4 overflow-x-auto no-scrollbar">
                                    <nav className="flex space-x-8 min-w-max">
                                        {[{ id: 'risk', label: t.tabRisk, icon: AlertTriangle }, { id: 'guidelines', label: t.tabGuide, icon: BookOpen }, { id: 'capability', label: t.tabCap, icon: GraduationCap }, { id: 'record', label: t.tabRecord, icon: BarChart3 }, { id: 'official', label: t.tabOfficial, icon: Building }].map((tab) => (
                                            <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex items-center gap-2 py-4 px-1 border-b-2 font-medium text-sm transition-colors whitespace-nowrap ${activeTab === tab.id ? 'border-emerald-600 text-emerald-700 dark:text-emerald-400' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'}`}>
                                                <tab.icon className="w-4 h-4" /> {tab.label}
                                            </button>
                                        ))}
                                    </nav>
                                </div>
                            </div>

                            <main className="container mx-auto px-4 py-8 flex-grow animate-in slide-in-from-bottom-2">
                                {activeTab === 'record' ? <LearningRecord t={t} progress={progress} handleExportCSV={handleExportCSV} userName={userName} school={school} currentDateTime={currentDateTime} lang={lang} /> : activeTab === 'official' ? <OfficialResources lang={lang} /> : (
                                    <>
                                        <div className="bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-100 dark:border-emerald-800 p-6 rounded-sm mb-8 flex items-start gap-4">
                                            <Lightbulb className="w-8 h-8 text-emerald-600 mt-1 flex-shrink-0" />
                                            <div><h2 className="text-xl font-bold text-slate-800 dark:text-slate-100 mb-2">{pageData.title} {t.summary}</h2><p className="text-slate-600 dark:text-slate-300 leading-relaxed">{pageData.summary}</p></div>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                                            <div className="md:col-span-2 space-y-8">
                                                <section>
                                                    <div className="flex items-center gap-2 mb-4 border-b border-slate-200 pb-2"><BookOpen className="w-5 h-5 text-blue-600" /><h3 className="font-bold text-slate-800 dark:text-white uppercase tracking-wider">{t.knowledge}</h3></div>
                                                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                                        {pageData.knowledge.map((item, i) => (
                                                            <FlipCard 
                                                                key={i} 
                                                                item={item} 
                                                                lang={lang} 
                                                                isOpen={openCardId === `knowledge-${i}`}
                                                                onToggle={() => setOpenCardId(prev => prev === `knowledge-${i}` ? null : `knowledge-${i}`)}
                                                            />
                                                        ))}
                                                    </div>
                                                </section>
                                                <section>
                                                    <div className="flex items-center gap-2 mb-4 border-b border-slate-200 pb-2"><Activity className="w-5 h-5 text-purple-600" /><h3 className="font-bold text-slate-800 dark:text-white uppercase tracking-wider">{t.skills}</h3></div>
                                                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                                        {pageData.skills.map((item, i) => (
                                                            <FlipCard 
                                                                key={i} 
                                                                item={item} 
                                                                lang={lang}
                                                                isOpen={openCardId === `skills-${i}`}
                                                                onToggle={() => setOpenCardId(prev => prev === `skills-${i}` ? null : `skills-${i}`)}
                                                            />
                                                        ))}
                                                    </div>
                                                </section>
                                                <section>
                                                    <div className="flex items-center gap-2 mb-4 border-b border-slate-200 pb-2"><User className="w-5 h-5 text-amber-600" /><h3 className="font-bold text-slate-800 dark:text-white uppercase tracking-wider">{t.attitude}</h3></div>
                                                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                                        {pageData.attitude.map((item, i) => (
                                                            <FlipCard 
                                                                key={i} 
                                                                item={item} 
                                                                lang={lang}
                                                                isOpen={openCardId === `attitude-${i}`}
                                                                onToggle={() => setOpenCardId(prev => prev === `attitude-${i}` ? null : `attitude-${i}`)}
                                                            />
                                                        ))}
                                                    </div>
                                                </section>
                                            </div>
                                            <div className="space-y-6">
                                                <div className="bg-white dark:bg-slate-800 p-6 rounded-sm shadow-sm border border-slate-200 dark:border-slate-700">
                                                    <div className="flex items-center justify-between mb-4"><h3 className="font-bold text-slate-800 dark:text-white flex items-center gap-2"><PlayCircle className="w-5 h-5 text-emerald-600" />{t.quiz}</h3>{quizSubmitted && <span className={`text-sm font-bold px-2 py-1 rounded ${quizScore === 3 ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}`}>{t.quizScore}: {quizScore}/{QUIZ_DISPLAY_COUNT}</span>}</div>
                                                    <div className="space-y-6">
                                                        {currentQuestions.map((q, idx) => {
                                                            const isCorrect = quizSubmitted && quizAnswers[idx] === q.ans;
                                                            return (
                                                                <div key={idx} className="space-y-2">
                                                                    <p className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">{idx + 1}. {q.q}</p>
                                                                    <div className="space-y-1">{q.options.map((opt, optIdx) => (<button key={optIdx} onClick={() => !quizSubmitted && setQuizAnswers(prev => ({...prev, [idx]: optIdx}))} disabled={quizSubmitted} className={`w-full text-left text-xs p-2 rounded border transition-colors ${quizAnswers[idx] === optIdx ? 'bg-emerald-50 border-emerald-500 text-emerald-700 font-semibold' : 'border-slate-200 text-slate-600 hover:bg-slate-50'} ${quizSubmitted && optIdx === q.ans ? '!bg-emerald-100 !border-emerald-600 !text-emerald-800' : ''} ${quizSubmitted && quizAnswers[idx] === optIdx && optIdx !== q.ans ? '!bg-red-100 !border-red-400 !text-red-800' : ''}`}><div className="flex justify-between items-center"><span>{opt}</span>{quizSubmitted && optIdx === q.ans && <CheckCircle className="w-4 h-4 text-emerald-600"/>}{quizSubmitted && quizAnswers[idx] === optIdx && optIdx !== q.ans && <XCircle className="w-4 h-4 text-red-600"/>}</div></button>))}</div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                    <div className="mt-6 pt-4 border-t border-slate-100">{!quizSubmitted ? <button onClick={handleQuizSubmit} className="w-full bg-emerald-600 text-white py-2 rounded-sm text-sm font-bold hover:bg-emerald-700 transition-colors shadow-sm">{t.checkAns}</button> : <button onClick={() => { setQuizSubmitted(false); setQuizAnswers({}); setQuizScore(0); const newIndices = getRandomIndices(pageData.quizPool.length, QUIZ_DISPLAY_COUNT); setCurrentQuestions(newIndices.map(i => pageData.quizPool[i])); }} className="w-full bg-slate-100 text-slate-600 py-2 rounded-sm text-sm font-bold hover:bg-slate-200 transition-colors">{t.tryAgain}</button>}</div>
                                                </div>
                                                <div className="bg-slate-100 dark:bg-slate-900 p-4 rounded-sm border border-slate-200 dark:border-slate-800">
                                                    <label className="text-xs font-bold text-slate-500 uppercase block mb-2">{t.glossary}</label>
                                                    <select className="w-full p-2 text-sm border border-slate-300 rounded-sm bg-white dark:bg-slate-800 dark:text-slate-300 mb-2" value={selectedGlossaryIndex} onChange={(e) => setSelectedGlossaryIndex(e.target.value)}><option value="" disabled>{t.selectTerm}</option>{pageData.glossary.map((g, i) => <option key={i} value={i}>{g.term.split('(')[0]}</option>)}</select>
                                                    {activeGlossaryItem ? <div className="bg-white dark:bg-slate-800 p-3 rounded-sm border-l-4 border-emerald-500 text-xs animate-in fade-in slide-in-from-top-1"><span className="block font-bold text-slate-700 dark:text-white mb-1">{activeGlossaryItem.term}</span><span className="text-slate-600 dark:text-slate-400 leading-relaxed">{activeGlossaryItem.def}</span></div> : <div className="text-xs text-slate-400 italic text-center p-2">{t.selectTerm}</div>}
                                                </div>
                                            </div>
                                        </div>
                                    </>
                                )}
                            </main>
                        </>
                    )}
                    
                    <footer className="bg-white dark:bg-slate-950 border-t border-slate-200 dark:border-slate-800 py-6 mt-8">
                        <div className="container mx-auto px-4 flex flex-col md:flex-row justify-between items-center text-xs text-slate-500 dark:text-slate-400">
                            <div className="mb-4 md:mb-0"><p>&copy; {new Date().getFullYear()} RSA Road Safety Advisor. Ver 2.8.0</p><p className="mt-1">{t.lastUpdate}: {lang === 'zh' ? currentDateTime.toLocaleDateString() : currentDateTime.toLocaleDateString('en-US')}</p></div>
                            <div className="flex items-center gap-6">
                                <a href={LINKS.prof} target="_blank" rel="noopener noreferrer" className="hover:text-emerald-600 transition-colors font-bold">{t.creator}</a><div className="h-3 w-px bg-slate-300"></div>
                                <a href={LINKS.ibs} target="_blank" rel="noopener noreferrer" className="hover:text-emerald-600 transition-colors">IBS</a><div className="h-3 w-px bg-slate-300"></div>
                                <a href={LINKS.ncnu} target="_blank" rel="noopener noreferrer" className="hover:text-emerald-600 transition-colors">NCNU</a>
                            </div>
                        </div>
                    </footer>
                </div>
            );
        };

        const App = () => {
            const [currentPage, setCurrentPage] = useState('login'); 
            const [activeTab, setActiveTab] = useState('risk'); 
            const [theme, setTheme] = useState('light');
            const [lang, setLang] = useState('zh'); 
            
            const [userName, setUserName] = useState('');
            const [userEmail, setUserEmail] = useState('');
            const [school, setSchool] = useState(DEFAULT_SCHOOL);
            const [currentDateTime, setCurrentDateTime] = useState(new Date());

            const [transport, setTransport] = useState('scooter');
            const [timeSlot, setTimeSlot] = useState('now');
            const [mapScale, setMapScale] = useState(300);
            const [startLocation, setStartLocation] = useState(LOCATIONS.start[0]);
            const [endLocation, setEndLocation] = useState(LOCATIONS.end[1]); // Default to City Center
            const [waypoints, setWaypoints] = useState([]);
            
            const [progress, setProgress] = useState({
                risk: { score: 0, total: 3, completed: false },
                guidelines: { score: 0, total: 3, completed: false },
                capability: { score: 0, total: 3, completed: false }
            });

            useEffect(() => {
                const timer = setInterval(() => setCurrentDateTime(new Date()), 1000);
                if (theme === 'dark') document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
                return () => clearInterval(timer);
            }, [theme]);

            const t = UI_TEXT[lang];
            const simData = useMemo(() => getSimulationData(timeSlot), [timeSlot]);
            const pageData = activeTab === 'record' || activeTab === 'official' ? null : CONTENT_DATA[activeTab][lang];

            const toggleTheme = (e) => { e.preventDefault(); setTheme(prev => prev === 'light' ? 'dark' : 'light'); };
            const toggleLang = (e) => { e.preventDefault(); setLang(prev => prev === 'zh' ? 'en' : 'zh'); };

            const handleLogin = (targetTab) => {
                if (!userName) return alert(lang === 'zh' ? '請輸入使用者名稱' : 'Please enter username');
                setActiveTab(targetTab);
                setCurrentPage('dashboard');
            };

            const handleLogout = () => {
                setUserName('');
                setUserEmail('');
                setSchool(DEFAULT_SCHOOL);
                setProgress({
                    risk: { score: 0, total: 3, completed: false },
                    guidelines: { score: 0, total: 3, completed: false },
                    capability: { score: 0, total: 3, completed: false }
                });
                setCurrentPage('login');
            };

            const handleAddWaypoint = () => {
                if (waypoints.length < 3) setWaypoints([...waypoints, { id: Date.now() }]);
            };

            return currentPage === 'login' ? (
                <LoginScreen 
                    lang={lang} t={t} toggleLang={toggleLang} theme={theme} toggleTheme={toggleTheme} 
                    userName={userName} setUserName={setUserName} userEmail={userEmail} setUserEmail={setUserEmail} 
                    school={school} setSchool={setSchool} handleLogin={handleLogin} links={LINKS} 
                />
            ) : (
                <Dashboard 
                    activeTab={activeTab} setActiveTab={setActiveTab} 
                    lang={lang} toggleLang={toggleLang} 
                    theme={theme} toggleTheme={toggleTheme}
                    userName={userName} school={school} currentDateTime={currentDateTime}
                    transport={transport} setTransport={setTransport}
                    timeSlot={timeSlot} setTimeSlot={setTimeSlot}
                    mapScale={mapScale} setMapScale={setMapScale}
                    startLocation={startLocation} setStartLocation={setStartLocation}
                    endLocation={endLocation} setEndLocation={setEndLocation}
                    waypoints={waypoints} handleAddWaypoint={handleAddWaypoint}
                    simData={simData} progress={progress} setProgress={setProgress}
                    pageData={pageData} handleLogout={handleLogout}
                />
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>